---
layout: post

title: RxSwift åŸç†åŠä½¿ç”¨ç»éªŒ 

date: 2017-03-10 15:32:24.000000000 +09:00

---

## åŸç†

### RxCocoaå¦‚ä½•å°†Cocoaå¯¹è±¡çš„æ¶ˆæ¯è½¬åŒ–ä¸ºå¯è¢«è®¢é˜…çš„æµ

```
        let button = UIButton()
        button.rx.sentMessage(#selector(UIButton.setTitle(_:for:)))
            .asObservable().subscribe { (event) in
                print( "event : \(event)") //next([Title, 0])
            }
            .addDisposableTo(disposeBag)
        button.setTitle("Title", for: UIControlState.normal)
```
åƒè¿™æ ·çš„ä¸€æ®µä»£ç ï¼Œè¡¨ç¤ºRxCocoaå°†Cocoaçš„å¯¹è±¡æ¶ˆæ¯å…¨éƒ½æ‹¦æˆªå¹¶è½¬åŒ–æˆäº†å¯ä»¥è¢«è®¢é˜…çš„Observable

é¦–å…ˆåˆ†æ UIButton çš„rxçš„å±æ€§æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ

```
/// Extend NSObject with `rx` proxy.
extension NSObject: ReactiveCompatible { }

public protocol ReactiveCompatible {
    associatedtype CompatibleType
    static var rx: Reactive<CompatibleType>.Type { get set }
    var rx: Reactive<CompatibleType> { get set }
}

extension ReactiveCompatible {
    public static var rx: Reactive<Self>.Type {
        get {
            return Reactive<Self>.self
        }
        set {
            // this enables using Reactive to "mutate" base type
        }
    }

    public var rx: Reactive<Self> {
        get {
            return Reactive(self)
        }
        set {
            // this enables using Reactive to "mutate" base object
        }
    }
}

public struct Reactive<Base> {
    public let base: Base
    public init(_ base: Base) {
        self.base = base
    }
}

```
ç»™ NSObject æ·»åŠ äº†ä¸€ä¸ª ReactiveCompatible åè®® ï¼Œå¹¶å¯¹è¿™ä¸ªåè®®ä½œæ‰©å±•äº†ã€‚ä¹Ÿå°±æ˜¯ç»™æ‰€æœ‰NSObjectéƒ½æ·»åŠ äº† *.rx* çš„å±æ€§ï¼Œè¿™ä¸ªå±æ€§è¿”å›çš„æ˜¯ä¸€ä¸ªå«Reactiveçš„å®¹å™¨ï¼Œå®¹å™¨é‡Œå°±æ˜¯åŸæœ¬çš„å¯¹è±¡ã€‚
è¿™ä¸ªå®¹å™¨æœ‰æ„æ€äº†ï¼Œä¸ä»…èƒ½æŠŠRxCocoaçš„apiå…¨éƒ½ç”¨ *.rx.* è¿™æ ·çš„æ–¹å¼å’ŒCocoaçš„apiéƒ½åŒºåˆ†å¼€ï¼Œè¿˜èƒ½ä¸ºè¿™ä¸ªå®¹å™¨å®ç°æ›´å¤šçš„åè®®ï¼Œæ‰©å±•å‡ºæ›´å¤šçš„æ–¹æ³•ã€‚ç”¨whereçº¦æŸçš„åŠæ³•ï¼Œæ‰©å±•å‡ºé’ˆå¯¹æŸä¸ªCocoaå¯¹è±¡ç‹¬ç‰¹çš„rxæ–¹æ³•ã€‚

``` 
extension Reactive where Base: UIButton {

    /// Reactive wrapper for `TouchUpInside` control event.
    public var tap: ControlEvent<Void> {
        return controlEvent(.touchUpInside)
    }
}
```

æ¥ä¸‹æ¥çœ‹çœ‹ sentMassageæ–¹æ³•:

```
extension Reactive where Base: AnyObject {
    public func sentMessage(_ selector: Selector) -> Observable<[Any]> {
        return synchronized {
            // in case of dealloc selector replay subject behavior needs to be used
            if selector == deallocSelector {
                return deallocating.map { _ in [] }
            }

            do {
                let proxy: MessageSentProxy = try registerMessageInterceptor(selector)
                return proxy.messageSent.asObservable()
            }
            catch let e {
                return Observable.error(e)
            }
        }
    }
}
```
è¿™é‡Œå…ˆä¸»è¦çœ‹å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª MessageSentProxy çš„ç±»å‹ ï¼Œä»–æœ‰PublishSubjectçš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¯¹ä½œä¸ºObservableï¼Œå‘é€ *.next(arguments)* ç­‰eventäº‹ä»¶ã€‚æ„å‘³ç€è¢«è½¬åŒ–çš„äº‹ä»¶æµå°†ç”±å®ƒå‘å¤–å‘é€ã€‚

ç„¶åç»§ç»­çœ‹å…³é”®çš„å‡½æ•° *registerMessageInterceptor(selector)* ä¸ºä¸€ä¸ªselectoræ³¨å†Œç›‘å¬è€…ã€‚

```
    fileprivate func registerMessageInterceptor<T: MessageInterceptorSubject>(_ selector: Selector) throws -> T {
        let rxSelector = RX_selector(selector)
        let selectorReference = RX_reference_from_selector(rxSelector)

        let subject: T
        if let existingSubject = objc_getAssociatedObject(base, selectorReference) as? T {
            subject = existingSubject
        }
        else {
            subject = T()
            objc_setAssociatedObject(
                base,
                selectorReference,
                subject,
                .OBJC_ASSOCIATION_RETAIN_NONATOMIC
            )
        }

        if subject.isActive {
            return subject
        }

        var error: NSError?
        let targetImplementation = RX_ensure_observing(base, selector, &error)
        if targetImplementation == nil {
            throw error?.rxCocoaErrorForTarget(base) ?? RxCocoaError.unknown
        }

        subject.targetImplementation = targetImplementation!

        return subject
    }
#endif
}

```
ç”Ÿæˆäº†ä¸€ä¸ª *MessageInterceptorSubject* å¯¹è±¡å¹¶å°†å®ƒç”¨ *objc_getAssociatedObject*æ–¹æ³•ç»‘å®šåˆ°è¿™ä¸ª *button* Cocoaçš„å®ä¾‹ä¸Šï¼Œä»¥ *selectorReference* ä¸ºKeyã€‚ç›®çš„æ˜¯ä¸ºè¿™ä¸ªå®ä¾‹ ä¿å­˜ä¸€ä¸ªå‘å¤–å‘é€eventäº‹ä»¶çš„ *subject*ã€‚ ç­‰*RX_ensure_observing*é‡Œé¢ä¼šç”¨*selectorReference*é‡æ–°å–å‡ºè¿™ä¸ª *subject*ï¼Œç„¶åå°†ç›‘å¬åˆ°çš„æ¶ˆæ¯éƒ½å‘ç»™ä»–ã€‚

ç»§ç»­çœ‹å…³é”®æ–¹æ³• *RX_ensure_observing*

```
IMP __nullable RX_ensure_observing(id __nonnull target, SEL __nonnull selector, NSError ** __nonnull error) {
    __block IMP targetImplementation = nil;
    @synchronized(target) {
        @synchronized([target class]) {
            [[RXObjCRuntime instance] performLocked:^(RXObjCRuntime * __nonnull self) {
                targetImplementation = [self ensurePrepared:target
                                               forObserving:selector
                                                      error:error];
            }];
        }
    }

    return targetImplementation;
}

```
*[RXObjCRuntime instance]* è¿™ä¸ªå®ä¾‹æ˜¯RxCocoa ç”¨æ¥æ“ä½œæ‰€æœ‰è¿è¡Œæ—¶çš„ä¸€ä¸ªå•ä¾‹ï¼Œå¯ä»¥åœ¨è¿™ä¸ªå•ä¾‹è°ƒç”¨è¿è¡Œæ—¶apiåŠ ä¸Šå„ç§é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ 

ç»§ç»­çœ‹ *ensurePrepared: forObserving: error:* è¦å¼€å§‹ä¸ºè¿™ä¸ªtargetçš„selectorçœŸæ­£çš„æ³¨å…¥ç›‘å¬è€…äº†ã€‚

```
-(IMP __nullable)ensurePrepared:(id __nonnull)target forObserving:(SEL __nonnull)selector error:(NSError** __nonnull)error {
	ï¼* ä¸€äº›å®‰å…¨ä»£ç  *ï¼
    if (selector == deallocSelector) {
		ï¼* ä¸€äº›é’ˆå¯¹deallocç‰¹æ®Šçš„å¤„ç†ä»£ç  *ï¼
    }
    else {
            Class __nullable swizzlingImplementorClass = [self prepareTargetClassForObserving:target error:error];

		ï¼* ä¸€äº›ä¼˜åŒ–æ¶ˆæ¯ç›‘å¬æ€§èƒ½çš„ä»£ç  *ï¼
        // optimized interception method
        if (optimizedIntercept != nil) {
		ï¼* ä¸€äº›ä¼˜åŒ–æ¶ˆæ¯ç›‘å¬æ€§èƒ½çš„ä»£ç  *ï¼
        }
        // default fallback to observing by forwarding messages
        else {
            if ([self forwardingSelector:selector forClass:swizzlingImplementorClass]) {
                return RX_default_target_implementation();
            }

            if (![self observeByForwardingMessages:swizzlingImplementorClass
                                          selector:selector
                                            target:target
                                             error:error]) {
                return nil;
            }

            if ([self forwardingSelector:selector forClass:swizzlingImplementorClass]) {
                return RX_default_target_implementation();
            }
        }
    }
    ï¼* ä¸€äº›å¤„ç†é”™è¯¯ä»£ç  *ï¼
}

```
*[self prepareTargetClassForObserving:target error:error]* æ–¹æ³•ä¸ºtarget è¿™ä¸ªç±»å‡†å¤‡ä¸€ä¸ªä¸­é—´ç±» *swizzlingImplementorClass* ã€‚ä¸ºäº†æ›¿æ¢ *target*çš„ isa æŒ‡é’ˆä»¥æ‹¦æˆªæ¶ˆæ¯

```
-(Class __nullable)prepareTargetClassForObserving:(id __nonnull)target error:(NSError **__nonnull)error {
	/* çœç•¥ä¸€äº›ä»£ç  */
    Class __nullable dynamicFakeSubclass = [self ensureHasDynamicFakeSubclass:wannaBeClass error:error];
    
    Class previousClass = object_setClass(target, dynamicFakeSubclass);//æ›¿æ¢ *target*çš„ isa æŒ‡é’ˆä»¥æ‹¦æˆªæ¶ˆæ¯ 

    objc_setAssociatedObject(target, &RxSwizzlingTargetClassKey, dynamicFakeSubclass, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
    return dynamicFakeSubclass;
}


-(Class __nullable)ensureHasDynamicFakeSubclass:(Class __nonnull)class error:(NSError **)error {
    Class dynamicFakeSubclass = self.dynamicSubclassByRealClass[CLASS_VALUE(class)];
    if (dynamicFakeSubclass != nil) {
        return dynamicFakeSubclass;
    }

    NSString *dynamicFakeSubclassName = [RX_PREFIX stringByAppendingString:NSStringFromClass(class)];
    const char *dynamicFakeSubclassNameRaw = dynamicFakeSubclassName.UTF8String;
    dynamicFakeSubclass = objc_allocateClassPair(class, dynamicFakeSubclassNameRaw, 0); //ï¼ï¼ï¼åˆ›å»ºä¸­é—´ç±»
    ALWAYS(dynamicFakeSubclass != nil, @"Class not generated");

    if (![self swizzleClass:dynamicFakeSubclass toActAs:class error:error]) {
        return nil;
    }//ï¼ï¼ï¼ä¿®æ”¹ä¸­é—´ç±»çš„classæ–¹æ³•ï¼Œæ¬ºéª—

    objc_registerClassPair(dynamicFakeSubclass);//ï¼ï¼ï¼åŠ¨æ€æ³¨å†Œç”Ÿäº§å¥½çš„ä¸­é—´ç±»

    [self.dynamicSubclassByRealClass setObject:dynamicFakeSubclass forKey:CLASS_VALUE(class)];
    ALWAYS(self.dynamicSubclassByRealClass[CLASS_VALUE(class)] != nil, @"Class not registered");

    return dynamicFakeSubclass;
}

```
ç›®å‰ä¸ºæ­¢ä¸­é—´ç±»å°±æˆåŠŸæ¥ç®¡äº†ï¼ŒUIButtonçš„æ‰€æœ‰æ–¹æ³•ã€‚è¿™ä¸ªåŸç†ç±»ä¼¼KVOçš„å®ç°ã€‚ä½†æ˜¯è¿™é‡Œä¸æ˜¯é‡å†™Cocoaæ–¹æ³• è€Œæ˜¯å°†è¦ç›‘å¬çš„ *selector* çš„ *IMP* æ”¹æˆ *_objc_msgForward* è®©è¿™ä¸ªæ¶ˆæ¯èµ°æ¶ˆæ¯è½¬å‘æµç¨‹ã€‚æœ€åé‡å†™ *forwardInvocation:* å‡½æ•°ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ã€‚

```
-(BOOL)observeByForwardingMessages:(Class __nonnull)swizzlingImplementorClass
                          selector:(SEL)selector
                            target:(id __nonnull)target
                             error:(NSError **__nonnull)error {
    if (![self ensureForwardingMethodsAreSwizzled:swizzlingImplementorClass error:error]) {
        return NO;
    }
    SEL rxSelector = RX_selector(selector);

    Method instanceMethod = class_getInstanceMethod(swizzlingImplementorClass, selector);

    IMP implementation = method_getImplementation(instanceMethod);

    if (!class_addMethod(swizzlingImplementorClass, rxSelector, implementation, methodEncoding)) {
        RX_THROW_ERROR([NSError errorWithDomain:RXObjCRuntimeErrorDomain
                                           code:RXObjCRuntimeErrorSavingOriginalForwardingMethodFailed
                                       userInfo:nil], NO);
    }

    if (!class_addMethod(swizzlingImplementorClass, selector, _objc_msgForward, methodEncoding)) {
        if (implementation != method_setImplementation(instanceMethod, _objc_msgForward)) {
            THREADING_HAZARD(swizzlingImplementorClass);
            RX_THROW_ERROR([NSError errorWithDomain:RXObjCRuntimeErrorDomain
                                               code:RXObjCRuntimeErrorReplacingMethodWithForwardingImplementation
                                           userInfo:nil], NO);
        }
    }
    [self registerForwardedSelector:selector forClass:swizzlingImplementorClass];

    return YES;
}

```
 *ensureForwardingMethodsAreSwizzled* æ–¹æ³•é‡Œæ›¿æ¢äº†ä¸­é—´ç±»çš„ *forwardInvocation* ä¸º æ–°çš„IMP 
 
```
-(BOOL)ensureForwardingMethodsAreSwizzled:(Class __nonnull)class error:(NSError ** __nonnull)error {
    NSValue *classValue = CLASS_VALUE(class);
    if ([self.classesThatSupportObservingByForwarding containsObject:classValue]) {
        return YES;
    }

    if (![self swizzleForwardInvocation:class error:error]) { return NO; }
    if (![self swizzleMethodSignatureForSelector:class error:error]) { return NO; }
    if (![self swizzleRespondsToSelector:class error:error]) { return NO; }

    [self.classesThatSupportObservingByForwarding addObject:classValue];

    return YES;
}

``` 
*swizzleForwardInvocation* ä½¿ç”¨å®å®šä¹‰å®ç°çš„ã€‚

```
SWIZZLE_INFRASTRUCTURE_METHOD(
    void,
    swizzleForwardInvocation,
    ,
    @selector(forwardInvocation:),
    FORWARD_BODY,
    NSInvocationRef
)
// RX_forward_invocation å°†æ•è·åˆ°çš„æ–¹æ³•å’Œå‚æ•° å‘é€ç»™ ä¹‹å‰ç”¨ selectorä¸ºkeyçš„subjectã€‚
#define FORWARD_BODY(invocation)
if (RX_forward_invocation(self, NAME_CAT(_, 0, invocation))) { return; }

//å®å±•å¼€çš„ä¸»è¦éƒ¨åˆ†
        id newImplementation = ^return_value(__unsafe_unretained id self DECLARE_ARGUMENTS(__VA_ARGS__)) {               \
            FORWARD_BODY(__VA_ARGS__)      //è¿™é‡Œè°ƒç”¨  RX_forward_invocation å‡½æ•°ã€‚                                                                                   
            struct objc_super superInfo = {\
                .receiver = self,                                                                                        
                .super_class = class_getSuperclass(class)                                                                
            };                                                                                                           
            return_value (*msgSend)(struct objc_super *, SEL DECLARE_ARGUMENTS(__VA_ARGS__))  //                            \
                = (__typeof__(msgSend))objc_msgSendSuper;                                                                \

```
ä¸»è¦æ˜¯ *RX_forward_invocation* å°†æ•è·åˆ°çš„æ–¹æ³•å’Œå‚æ•° å‘é€ç»™ ä¹‹å‰ç”¨ selectorä¸ºkeyçš„subjectã€‚
å°†æ–°çš„ *newImplementation* IMP æ›¿æ¢åˆ°åŸæ¥çš„*forwardInvocation:*ä¸Šã€‚åœ¨ *RX_forward_invocation* è½¬å‘å®Œæ¶ˆæ¯åã€‚ä¹Ÿè¦æŠŠæ¶ˆæ¯ä¼ ç»™ *çˆ¶ç±» ï¼šUIButton*ã€‚ç»§ç»­è¿™ä¸ªæ¶ˆæ¯çš„ä»»åŠ¡ã€‚

```
static BOOL RX_forward_invocation(id __nonnull __unsafe_unretained self, NSInvocation *invocation) {
    SEL originalSelector = RX_selector(invocation.selector);

    id<RXMessageSentObserver> messageSentObserver = objc_getAssociatedObject(self, originalSelector);

    if (messageSentObserver != nil) {
        NSArray *arguments = RX_extract_arguments(invocation);
        [messageSentObserver messageSentWithArguments:arguments];
    }

    if ([self respondsToSelector:originalSelector]) {
        invocation.selector = originalSelector;
        [invocation invokeWithTarget:self];

        if (messageSentObserver != nil) {
            NSArray *arguments = RX_extract_arguments(invocation);
            [messageSentObserver methodInvokedWithArguments:arguments];
        }

        return YES;
    }

    return NO;
}
```


### ç›‘å¬UIKitå¯¹è±¡çš„Delegateçš„æ–¹æ³•

```
        let web = UIWebView()
        web.loadRequest(URLRequest(url: URL(string:"baidu.com")!))
        web.rx.didStartLoad
            .asObservable()
            .subscribe { (event) in
            print("event : \(event)")    //event : next(())
        }.addDisposableTo(disposeBag)
        self.view.addSubview(web)
```
ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†RxCocoaè·å–åŸæœ¬UIWebViewï¼Œdelegateçš„æ–¹æ³• å¹¶è½¬åŒ–ä¸º Observableã€‚

*didStartLoad* çš„æ–¹æ³•åœ¨è¿™é‡Œ 

```
    extension Reactive where Base: UIWebView {
        public var delegate: DelegateProxy {
            return RxWebViewDelegateProxy.proxyForObject(base)
        }
        public var didStartLoad: Observable<Void> {
            return delegate
                .methodInvoked(#selector(UIWebViewDelegate.webViewDidStartLoad(_:)))
                .map {_ in}
        }
```

åŸæ¥ RxCocoa å…ˆæ·»åŠ ä¸€ä¸ª *DelegateProxy* ç±»æ¥åšè‡ªå·±çš„ä»£ç†ã€‚åº”è¯¥æ˜¯ç”¨æ¥ç›‘å¬åŸæœ¬ *delegate* çš„å›è°ƒæ–¹æ³•çš„ã€‚çœ‹çœ‹ *RxWebViewDelegateProxy.proxyForObject(base)* ç”Ÿæˆ*DelegateProxy*çš„æ–¹æ³•ã€‚

```
public protocol DelegateProxyType : AnyObject { 
	/* ä¸€äº›æ–¹æ³•åˆ—è¡¨ *ï¼
}

extension DelegateProxyType {

    public static func proxyForObject(_ object: AnyObject) -> Self {
        MainScheduler.ensureExecutingOnScheduler()

        let maybeProxy = Self.assignedProxyFor(object) as? Self

        let proxy: Self
        if let existingProxy = maybeProxy {
            proxy = existingProxy
        }
        else {
            proxy = Self.createProxyForObject(object) as! Self
            Self.assignProxy(proxy, toObject: object)
            assert(Self.assignedProxyFor(object) === proxy)
        }

        let currentDelegate: AnyObject? = Self.currentDelegateFor(object)

        if currentDelegate !== proxy {
            proxy.setForwardToDelegate(currentDelegate, retainDelegate: false)
            assert(proxy.forwardToDelegate() === currentDelegate)
            Self.setCurrentDelegate(proxy, toObject: object)
            assert(Self.currentDelegateFor(object) === proxy)
            assert(proxy.forwardToDelegate() === currentDelegate)
        }
        
        return proxy
    }
}
```
åŸæ¥å’±ä»¬çš„ *DelegateProxy* å®ç°äº† *DelegateProxyType* è¿™ä¸ªåè®®ï¼Œå¾—åˆ°äº†è¿™ä¸ªæ‰©å±•æ–¹æ³•ã€‚åè®®æ‰©å±•ä¸­ *proxy = Self.createProxyForObject(object) as! Self*  å°±ç”Ÿæˆäº†ä¸€ä¸ª *DelegateProxy*ï¼ ä¹‹åè®¾ç½®è¿™ä¸ª *proxy* ä¸º UIWebViewçš„ä»£ç† *Self.setCurrentDelegate(proxy, toObject: object)* ï¼Œå¦‚æœUIWebViewæœ¬èº«å·²ç»æœ‰ä»£ç†çš„è¯ã€‚å°†è¿™ä¸ªä»£ç†ä¿å­˜åˆ° *proxy.setForwardToDelegate(currentDelegate, retainDelegate: false)*ä¸­ã€‚ä»¥ä¾¿æ¶ˆæ¯çš„ç»§ç»­ä¼ é€’ã€‚

å†çœ‹çœ‹ *DelegateProxy* çš„ *methodInvoked* æ–¹æ³•

```
    open func methodInvoked(_ selector: Selector) -> Observable<[Any]> {
        checkSelectorIsObservable(selector)

        let subject = methodInvokedForSelector[selector]

        if let subject = subject {
            return subject
        }
        else {
            let subject = PublishSubject<[Any]>()
            methodInvokedForSelector[selector] = subject
            return subject
        }
    }
```
åŸæ¥åœ¨ *methodInvoked* æ–¹æ³•ä¸­ï¼Œä¸º *DelegateProxy* æ”¶é›†äº†ä¸€äº›éœ€è¦ç›‘å¬çš„ *Selector* åœ¨ *methodInvokedForSelector*é‡Œã€‚ 

ä¸Šä¸€æ­¥ï¼Œå·²ç»å°†ç”Ÿæˆçš„*DelegateProxy* å˜æˆäº†UIWebViewçš„ä»£ç†ï¼Œå½“æœ‰ *delegate* åˆ°æ¶ˆæ¯å›è°ƒæ—¶ï¼Œä¼šçœ‹è¿™ä¸ªæ¶ˆæ¯æ˜¯å¦åœ¨ç›‘å¬åˆ—è¡¨é‡Œï¼Œå¦‚æœæ˜¯çš„è¯ã€‚å°±æŠŠå®ƒè½¬åŒ–æˆ *event* é€šè¿‡ *subject* å‘é€å‡ºå»ã€‚

### RxSwiftçš„Observerå’ŒObservableå®ç°åŸç†

#### è§‚å¯Ÿè€… Observer 

```
public protocol ObserverType {
    associatedtype E
    func on(_ event: Event<E>)
}

extension ObserverType {
    public final func onNext(_ element: E) {
        on(.next(element))
    }
    public final func onCompleted() {
        on(.completed)
    }
    public final func onError(_ error: Swift.Error) {
        on(.error(error))
    }
}
```

ä½œä¸ºè§‚å¯Ÿè€…ç±»å‹ *ObserverType* æ˜¯æœ‰èƒ½åŠ›å¤„ç†nextï¼errorï¼completedäº‹ä»¶çš„ï¼Œä¾‹å¦‚UIKitæ‰€æœ‰ç”¨äºå±•ç¤ºæ•°æ®çš„æ§ä»¶ï¼Œä»–ä»¬å¯ä»¥ç»‘å®šä¿¡å·æºçš„æ¥æ—¶åˆ»æ›´æ–°è‡ªå·±çš„æ•°æ®ã€‚è¿”å›UIBindingObserverå°±æ˜¯*ObserverType*ç±»å‹ï¼Œä»–ä»¬æœ‰å¤„ç†nextï¼errorï¼completedçš„èƒ½åŠ›ã€‚

```
extension Reactive where Base: UILabel {
    public var text: UIBindingObserver<Base, String?> {
        return UIBindingObserver(UIElement: self.base) { label, text in
            label.text = text
        }
    }

```
#### è¢«è§‚å¯Ÿè€… Observerable

å¯ä»¥è¢«å…¶ä»–äººè®¢é˜…çš„ã€‚

```
 public protocol ObservableType : ObservableConvertibleType {
    associatedtype E
    func subscribe<O: ObserverType>(_ observer: O) -> Disposable where O.E == E
}

```
#### *Observer* å’Œ *Observable* ä»–ä»¬æ˜¯å¦‚ä½•è¿æ¥åœ¨ä¸€èµ·çš„ï¼Ÿ

```

class MyObserver :ObserverType{
    typealias E = Int
    func on(_ event: Event<E>){
        print(" on event : \(event)")
    }
}

Observable.of(1,2,3,4)
    .asObservable()
    .subscribe(o)
    .addDisposableTo(disposeBag)
//        on event : next(1)
//        on event : next(2)
//        on event : next(3)
//        on event : next(4)
//        on event : completed

```

æ–­ç‚¹åœåœ¨ *subscribe*ä¸Šå¯ä»¥çœ‹åˆ°

```
    override func subscribe<O : ObserverType>(_ observer: O) -> Disposable where O.E == Element {
        if !CurrentThreadScheduler.isScheduleRequired {
            // The returned disposable needs to release all references once it was disposed.
            let disposer = SinkDisposer()
            let sinkAndSubscription = run(observer, cancel: disposer)
            disposer.setSinkAndSubscription(sink: sinkAndSubscription.sink, subscription: sinkAndSubscription.subscription)

            return disposer
        }
        else {
            return CurrentThreadScheduler.instance.schedule(()) { _ in
                let disposer = SinkDisposer()
                let sinkAndSubscription = self.run(observer, cancel: disposer)
                disposer.setSinkAndSubscription(sink: sinkAndSubscription.sink, subscription: sinkAndSubscription.subscription)

                return disposer
            }
        }

```

*CurrentThreadScheduler.isScheduleRequired*è¡¨ç¤ºå½“å‰çº¿ç¨‹çš„è°ƒåº¦è€…*CurrentThreadScheduler*éœ€è¦è°ƒåº¦ä»»åŠ¡ã€‚
ä¸€èˆ¬æœ€å¼€å§‹ç”¨æˆ·è®¢é˜…æƒ…å†µä¸‹ï¼Œ*isScheduleRequired*æ˜¯YESï¼Œæ‰€ä»¥è¿™é‡Œä¼šèµ°ä¸‹é¢ï¼Œæ„æ€æ˜¯å½“å‰çº¿ç¨‹çš„è°ƒåº¦è€…è®¢é˜…ä¸€ä¸ª å¯æ‰§è¡Œçš„ *block* ï¼Œè¿™ä¸ª *block* çš„ä½œç”¨æ˜¯å°† 1ï¼Œ2ï¼Œ3ï¼Œ4 è¿™ä¸€ç»„äº‹ä»¶ç”Ÿäº§ä¸€ä¸ª*ScheduledItem*åˆ°è‡ªå·±çš„è°ƒåº¦é˜Ÿåˆ— *queue*ä¸Šã€‚ç­‰å¾…æ´¾å‘ã€‚

```
    public func schedule<StateType>(_ state: StateType, action: @escaping (StateType) -> Disposable) -> Disposable {
        if CurrentThreadScheduler.isScheduleRequired {
            CurrentThreadScheduler.isScheduleRequired = false

            let disposable = action(state)   //è¿™é‡Œå°±æ˜¯å¼€å§‹å‘é˜Ÿåˆ—queueä¸­æ·»åŠ *ScheduledItem*

            defer {
                CurrentThreadScheduler.isScheduleRequired = true
                CurrentThreadScheduler.queue = nil
            }

            guard let queue = CurrentThreadScheduler.queue else {
                return disposable
            }

            while let latest = queue.value.dequeue() { //è¿™é‡Œå°±æ˜¯ä»é˜Ÿåˆ—queueä¸­å–å‡º*ScheduledItem*ï¼Œä¾æ¬¡æ´¾å‘
                if latest.isDisposed {
                    continue
                }
                latest.invoke()
            }

            return disposable
        }

        let existingQueue = CurrentThreadScheduler.queue

        let queue: RxMutableBox<Queue<ScheduledItemType>>
        if let existingQueue = existingQueue {
            queue = existingQueue
        }
        else {
            queue = RxMutableBox(Queue<ScheduledItemType>(capacity: 1))
            CurrentThreadScheduler.queue = queue
        }

        let scheduledItem = ScheduledItem(action: action, state: state)
        queue.value.enqueue(scheduledItem)

        return scheduledItem
    }
```


//å¾…ç»­ã€‚ã€‚ã€‚ã€‚



### DisposeBag å†…å­˜å›æ”¶å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

RxSwiftä¸­ å†…å­˜èµ„æºçš„å›æ”¶å…¨éƒ½é ä¸€ä¸ªã€‚*DisposeBag()* ä»–å°±åƒä¸€ä¸ªåƒåœ¾è¢‹å„¿ã€‚å°†RxSwiftæ¯æ¬¡å‘ç”Ÿè®¢é˜…äº‹ä»¶ *subscribe* æ—¶äº§ç”Ÿçš„ *Disposable* éƒ½æ”¾åˆ°*DisposeBag()*é‡Œã€‚åœ¨è¿™ä¸ªåƒåœ¾è¢‹å„¿é‡Šæ”¾æ—¶ï¼ŒRxSwifté“¾å¼è°ƒç”¨æ‰€äº§ç”Ÿçš„èµ„æºå°†å…¨éƒ½ä¸€èµ·é‡Šæ”¾ï¼Œè¯·çœ‹ä»£ç ã€‚

```
public final class DisposeBag: DisposeBase {
        
    // state
    private var _disposables = [Disposable]() // åƒåœ¾

    private func dispose() {  // deinit æ—¶å€™å°±æ‰§è¡Œæ‰€æœ‰åƒåœ¾çš„æ¸…ç†æ–¹æ³•
        let oldDisposables = _dispose()

        for disposable in oldDisposables {
            disposable.dispose()
        }
    }
    
    deinit {
        dispose()
    }
}

```
äº§ç”Ÿèµ„æºçš„æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªå®ç° *Disposable* åè®®çš„å¯¹è±¡ï¼Œå¯¹è¿™ä¸ªå¯¹è±¡æ‰§è¡Œ *dispose()*å°±é‡Šæ”¾äº†å®ƒæ‰€æœ‰åˆ›å»ºçš„èµ„æºï¼ŒåŒ…æ‹¬ä¾èµ–å®ƒå£°æ˜å‘¨æœŸçš„å…¶ä»–*Disposable*å¯¹è±¡ä¹Ÿä¼šåœ¨ä»–çš„*dispose()*é‡Œä¸€èµ·è¢«é‡Šæ”¾ã€‚

```
public protocol Disposable {
    /// Dispose resource.
    func dispose()
}
```
## ä½¿ç”¨ç»éªŒ

### ObservableTypeç±»å‹çš„doOnæ“ä½œ

å¯ä»¥ç†è§£ä¸ºåœ¨è®¢é˜…æ¶ˆæ¯çš„åŒæ—¶ï¼Œç›‘å¬æ¯ä¸€ä¸ªæ¶ˆæ¯ï¼ŒonErroræ–¹æ³•ç›‘å¬Erroræ¶ˆæ¯ï¼Œå°±ä¼šè§¦å‘onErrorçš„Block

````
 Observable.of("ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹")
        .do(onNext: { print("Intercepted:", $0) }, onError: { print("Intercepted error:", $0) }, onCompleted: { print("Completed")  })
        .subscribe(onNext: { print($0) })
        .disposed(by: disposeBag)
````


### RxSwift é‡Œ map å’Œ flatMap?
å…ˆçœ‹çœ‹Swifté‡Œé¢ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š

```
let arrayNested = [[1,2,3,4,5],[6,7]]

let maped2 = arrayNested.map { $0 }
print(maped2) // [[1, 2, 3, 4, 5], [6, 7]]

let flaped2 = arrayNested.flatMap { $0 }
print(flaped2) // [1, 2, 3, 4, 5, 6, 7]

```

flatMap èƒ½å°†äºŒç»´æ•°ç»„å±•å¼€æˆä¸€ç»´æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯ *é™ç»´*
> flatMap è°ƒç”¨ä¸€æ¬¡åªèƒ½å±•å¼€ä¸€å±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚ä¸‰ç»´æ•°ç»„æ—¶è°ƒç”¨ä¸€æ¬¡flatMapä¼šå˜ä¸ºäºŒç»´æ•°ç»„ï¼Œè°ƒç”¨ä¸¤æ¬¡æ‰ä¼šå˜ä¸ºä¸€ç»´æ•°ç»„

RxSwiftä¸­ ä¹Ÿæ˜¯åŒæ ·çš„ç±»ä¼¼çš„æ¦‚å¿µ.

```
    let b = Observable.of( Observable.of("ğŸ¶", "ğŸ±"),
                           Observable.of("ğŸ­", "ğŸ¹"))
    
        b.map{ $0 }
        .subscribe(onNext: { element in
            print(element)
            //RxSwift.ObservableSequence<Swift.Array<Swift.String>>
            //RxSwift.ObservableSequence<Swift.Array<Swift.String>>
        })
        .disposed(by: disposeBag)

        b.flatMap{ $0 }
        .subscribe(onNext: { element in
            print(element)
            //ğŸ¶
            //ğŸ±
            //ğŸ­
            //ğŸ¹
        })
        .disposed(by: disposeBag)

```
ä¸¾ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­

```
button
    .rx
    .tap
    .map { URL(string: "http://httpbin/org")! }
    .flatMap(URLSession.shared.rx.JSON)
    .subscribe { event in
        switch event {
        // ...
        }
    }
    .addDisposableTo(disposeBag)
    
```
å¯ä»¥ç†è§£ä¸º 

```
Observable<Void> -> Observable<Foundation.URL> -> Observable<Observable<jsonData>>  

```
è¿™æ ·çš„è½¬æ¢ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ ç¬¬ä¸€mapä¼ å…¥çš„é—­åŒ…è¿”å›çš„æ˜¯ `URL` 
 
```
 	{ _ -> URL in 
		retrun URL(string: "http://httpbin/org")! 
	}

```

è€Œç¬¬äºŒæ­¥flatMapä¼ å…¥çš„é—­åŒ…è¿”å›çš„æ˜¯ `Observable<jsonData>`

```
public func json(url: Foundation.URL) -> Observable<jsonData> {
    return json(request: URLRequest(url: url))
}
```

Rxswift ä¸­ Observable å’Œ Swift çš„ [] æ•°ç»„ å¾ˆåƒã€‚

Swift çš„ flatMap å¯ä»¥ä½¿ [[1,2,3,4,5],[6,7]] -> [1,2,3,4,5,6,7]

Rxswift çš„ flatMap å¯ä»¥ä½¿ Observable<Observable<Any>> -> Observable<Any>

è¿˜å¯ä»¥ç†è§£ä¸º ç¬¬äºŒä¸ªæ˜ å°„ *(map/flatmap éƒ½å¯ä»¥ç†è§£ä¸ºæ˜ å°„)* æ˜¯ä¸€ä¸ªå‡ç»´çš„è¿‡ç¨‹ *(ä»ä¸€ç»´å˜äºŒç»´)* éœ€è¦ç”¨flatmapå‡½æ•°å°†è¿™ä¸ªå‡èµ·çš„ç»´åº¦é™å›æ¥ï¼Œæ‹¿åˆ°å’±ä»¬çœŸæ­£è¦æƒ³è¦çš„ *Observable<jsonData>* 
å½“ä¸çŸ¥é“ç”¨mapå’Œflatmapå“ªä¸€ä¸ªæ—¶ï¼Œè€ƒè™‘ä¸‹ç°åœ¨çš„ç»´åº¦æ˜¯ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚Rxswifté‡Œ *Value -> Observable<E>* è¿™æ ·çš„è¿‡ç¨‹éƒ½æ˜¯å‡ç»´çš„ã€‚

æ­¤å¤– flatMap è¿˜æœ‰ä¸¤ä¸ªå…„å¼Ÿæ–¹æ³•ï¼ŒflatMapFirst flatMapLatest ï¼Œæ¯”å¦‚åœ¨ç½‘ç»œè¯·æ±‚æœªå®Œæˆæ—¶ï¼Œå†æ¬¡ç‚¹å‡»äº† Button ï¼ŒflatMapFirst ä¼šå¿½ç•¥ç¬¬äºŒæ¬¡ç‚¹å‡» Button çš„äº‹ä»¶ï¼Œä¸ä¼šè¿›è¡Œç½‘ç»œè¯·æ±‚ï¼›è€Œ flatMapLatest ä¼šå–æ¶ˆç¬¬ä¸€æ¬¡çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥ç¬¬äºŒæ¬¡çš„ç½‘ç»œè¯·æ±‚è¦†ç›–æ‰ã€‚

[å‚è€ƒ](http://edison-hsu.com/blog/2016/12/11/RxSwiftä¸­FlapMapå’ŒMapçš„åŒºåˆ«)

### ç”¨Observableè¿˜æ˜¯Driver

Driver ä¼˜åŠ¿åœ¨ä½¿ä»£ç æ˜æ˜¾åœ¨ä¸»çº¿ç¨‹å®Œæˆï¼Œç›¸å¯¹åˆ‡æ¢çº¿ç¨‹å°±æ¯”è¾ƒéº»çƒ¦ã€‚

[Driver vs Observable](http://t.swift.gg/d/61-driver-vs-observable)

### RxSwiftä¸­çš„é”™è¯¯æœºåˆ¶

RxSwiftä¸­ï¼Œå¤šå±äºå¼‚æ­¥è°ƒç”¨APIï¼Œå»ºè®®ç”¨èŒƒå‹æšä¸¾å°†é”™è¯¯å’Œæ­£ç¡®çš„ç»“æœåŒ…è£…èµ·æ¥ä¼ é€’ä¸‹å»ã€‚

```
enum Result<T> {
    case value(T)
    case error(ErrorProtocol)
}

provider.request(GitHubAPI.Authorize)
    .map { result -> Result<String> in
        switch result {
        case .value(let value):
            return Result.value(value["token"].stringValue)
        case .error(let error):
            return Result.error(error)
        }
    }
    .flatMap { result -> Observable<Result<JSON>> in
        switch result {
        case .value(let token):
            return provider.request(GitHubAPI.AccessToken(code: token))
        case .error(let error):
            return Observable.just(Result.error(error))
        }
    }
    .subscribeNext { json in
        // ...
    }

```

+ [é”™è¯¯å¤„ç†](http://t.swift.gg/d/28-011)
+ [ä½¿ç”¨ Result ä¼ é€’å€¼](http://t.swift.gg/d/56-rxswift-1-result)
+ [ä½¿ç”¨å‡½æ•°å¼å¤ç”¨ä»£ç ](http://t.swift.gg/d/57-rxswift-2)



## æ€»ç»“

RxSwift å‡½æ•°å¼ç¼–ç¨‹ï¼šå‡½æ•°å¼æ€ç»´ï¼Œå…¶å®å°±æ˜¯ç»„åˆå­é€»è¾‘ï¼Œç”¨ç®€å•çš„å‡ ä¸ªå‡½æ•°ç»„åˆæ¥æ„å»ºå¤æ‚é€»è¾‘ï¼Œå§‹ç»ˆä»¥é«˜é˜¶çš„è§’åº¦å»è¡¨è¾¾é—®é¢˜ï¼Œè€Œéä¾èµ–å‰¯ä½œç”¨ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å‡½æ•°å¼ç¼–ç¨‹æ„å‘³ç€ä¸ä½¿ç”¨å¯å˜çš„å˜é‡ï¼Œèµ‹å€¼ï¼Œå¾ªç¯å’Œå…¶ä»–å‘½ä»¤å¼æ§åˆ¶ç»“æ„è¿›è¡Œç¼–ç¨‹ã€‚
ReactiveXæ˜¯Reactive Extensionsçš„ç¼©å†™ï¼Œä¸€èˆ¬ç®€å†™ä¸ºRx ã€‚Rxæ˜¯ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹ï¼Œç›®æ ‡æ˜¯æä¾›ä¸€è‡´çš„ç¼–ç¨‹æ¥å£ï¼Œå¸®åŠ©å¼€å‘è€…æ›´æ–¹ä¾¿çš„å¤„ç†å¼‚æ­¥æ•°æ®æµ

Rxçš„Observableæ¨¡å‹è®©ä½ å¯ä»¥åƒä½¿ç”¨é›†åˆæ•°æ®ä¸€æ ·æ“ä½œå¼‚æ­¥äº‹ä»¶æµï¼Œå¯¹å¼‚æ­¥äº‹ä»¶æµä½¿ç”¨å„ç§ç®€å•ã€å¯ç»„åˆçš„æ“ä½œã€‚

è¿‡æ»¤(filter)ã€é€‰æ‹©(select)ã€å˜æ¢(transform)ã€ç»“åˆ(combine)å’Œç»„åˆ(compose)å¤šä¸ªObservable

æ€§èƒ½ä¸Šï¼é«˜é˜¶æ•°æ®ç®—æ³• å¯ä»¥è®²ä»»åŠ¡åˆ†æˆå°å—å„¿ åˆ©ç”¨å¤šæ ¸è¿ç®— æ€§èƒ½å¿« ã€‚
å®‰å…¨ä¸Šï¼å› ä¸ºä¸ä¿®æ”¹å‚æ•°å€¼ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨ å› ä¸ºéƒ½æ˜¯å€¼ç±»å‹ è¾“å…¥ä¸€æ ·è¾“å‡ºå°±ä¸€æ ·
æ€æƒ³ä¸Šï¼ç”¨ç®€å•çš„å‡ ä¸ªå‡½æ•°ç»„åˆæ¥æ„æˆå¤æ‚çš„é€»è¾‘ï¼Œå§‹ç»ˆä»¥é«˜ä»·çš„è§’åº¦å»è¡¨è¾¾é—®é¢˜ï¼Œè€Œéä¾èµ–å‰¯ä½œç”¨ï¼Œå¼‚æ­¥æ“ä½œprimose

è‡ªæˆ‘æ€»ç»“çš„å‡½æ•°å¼ç¼–ç¨‹ï¼š
          åƒä»¥å‰æœåŠ¡å™¨çš„apiä¸æ˜¯Restfulé£æ ¼ä¸€æ ·ï¼Œå…¶å®æ“ä½œæ•°æ®çš„æ–¹å¼å¯ä»¥æŠ½è±¡å½’çº³ä¸ºå‡ ç§æ¯”å¦‚ï¼šå¢åˆ æ”¹æŸ¥å°±å¤Ÿäº†ã€‚è€Œå‡½æ•°å¼ç¼–ç¨‹åˆ™æ˜¯æŠŠæŠ½è±¡å½’çº³æ“ä½œæ•°æ®çš„å‡ ç§æ–¹æ³• æ¯”å¦‚ï¼šMap è½¬æ¢ Reduce è¿­ä»£ filter ç­›é€‰ connect è¿æ¥ combine ç»„åˆ ç­‰æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°éƒ½ç”¨blockå°è£…èµ·æ¥ï¼Œ

Wiki ç™¾ç§‘ï¼š
          å®ƒå°†ç”µè„‘è¿ç®—è§†ä¸ºæ•°å­¦ä¸Šçš„å‡½æ•°è®¡ç®—ï¼Œå¹¶ä¸”é¿å…ä½¿ç”¨ç¨‹åºçŠ¶æ€ä»¥åŠæ˜“å˜å¯¹è±¡ã€‚å‡½æ•°ç¼–ç¨‹è¯­è¨€æœ€é‡è¦çš„åŸºç¡€æ˜¯Î»æ¼”ç®—ï¼ˆlambda calculusï¼‰ã€‚è€Œä¸”Î»æ¼”ç®—çš„å‡½æ•°å¯ä»¥æ¥å—å‡½æ•°å½“ä½œè¾“å…¥ï¼ˆå¼•æ•°ï¼‰å’Œè¾“å‡ºï¼ˆä¼ å‡ºå€¼ï¼‰ã€‚