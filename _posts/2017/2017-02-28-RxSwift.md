---
layout: post

title: RxSwift åŸç†åŠä½¿ç”¨ç»éªŒ 

date: 2017-02-28 15:32:24.000000000 +09:00

---

## åŸç†

### RxCocoa å¦‚ä½•å°†UIKitçš„ä»£ç†ï¼é€šçŸ¥ï¼KVOæ–¹æ³•è½¬åŒ–ä¸ºäº‹ä»¶æµ

RxSwiftåˆ©ç”¨Runtimeç›‘å¬Cocoaæ¡†æ¶ä¸­å¯¹è±¡çš„æ–¹æ³•ï¼Œå°†ä»£ç† é€šçŸ¥ KVO ç­‰æ–¹æ³•è½¬åŒ–ä¸ºæµã€‚

ä¾‹å¦‚KVOçš„æ–¹æ³•ï¼š

ç›‘å¬Father ,åœ¨Runtimeæ—¶åˆ›å»º ä¸€ä¸ªSonä¸­é—´ç±»ç»§æ‰¿Father ï¼Œåœ¨Soné‡Œå†™æ–°çš„@selector(work:)ï¼Œä¸Fatherçš„å®ç°æ–¹å¼äº’æ¢ç”¨Swizzleæ–¹æ³•ï¼ŒforwardInvocation æ–¹æ³•äº’æ¢ï¼Œå¹¶æŠŠFatherçš„@selectorè®¾ç½®_objc_msgForward. è¿™æ ·Fatherå°±æ— æ³•è¯†åˆ«@selector(work:)ï¼Œå¼€å§‹æ¶ˆæ¯è½¬å‘ï¼Œç”±äºforwardInvocationå®ç°è¢«è°ƒæ¢ï¼Œæ‰§è¡ŒSoné‡Œçš„ forwardInvocationã€‚å°±å¯ä»¥æŠŠæ¶ˆæ¯çš„å‚æ•°æ•è·åˆ°ï¼Œä¹‹åå†forwardInvocation å†ä¼ ç»™è‡ªå·±çš„Sonçš„@selector(work:)ï¼Œå…¶å®æ˜¯Father çš„å®ç°æ–¹æ³•ã€‚

[å‚è€ƒ](http://www.jianshu.com/p/77acd1bba906)

### RxSwift çš„Observerå’ŒObservableå®ç°åŸç†

#### è§‚å¯Ÿè€… Observer 

```
public protocol ObserverType {
    associatedtype E
    func on(_ event: Event<E>)
}

extension ObserverType {
    public final func onNext(_ element: E) {
        on(.next(element))
    }
    public final func onCompleted() {
        on(.completed)
    }
    public final func onError(_ error: Swift.Error) {
        on(.error(error))
    }
}
```

ä½œä¸ºè§‚å¯Ÿè€…ç±»å‹ *ObserverType* æ˜¯æœ‰èƒ½åŠ›å¤„ç†nextï¼errorï¼completedäº‹ä»¶çš„ï¼Œä¾‹å¦‚UIKitæ‰€æœ‰ç”¨äºå±•ç¤ºæ•°æ®çš„æ§ä»¶ï¼Œä»–ä»¬å¯ä»¥ç»‘å®šä¿¡å·æºçš„æ¥æ—¶åˆ»æ›´æ–°è‡ªå·±çš„æ•°æ®ã€‚è¿”å›UIBindingObserverå°±æ˜¯*ObserverType*ç±»å‹ï¼Œä»–ä»¬æœ‰å¤„ç†nextï¼errorï¼completedçš„èƒ½åŠ›ã€‚

```
extension Reactive where Base: UILabel {
    public var text: UIBindingObserver<Base, String?> {
        return UIBindingObserver(UIElement: self.base) { label, text in
            label.text = text
        }
    }

```

#### è¢«è§‚å¯Ÿè€… Observerable

å¯ä»¥è¢«å…¶ä»–äººè®¢é˜…çš„ã€‚

```
 public protocol ObservableType : ObservableConvertibleType {
    associatedtype E
    func subscribe<O: ObserverType>(_ observer: O) -> Disposable where O.E == E
}

```

### å†…å­˜å›æ”¶æœºåˆ¶ è¿™ä¸ªå¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ


## ä½¿ç”¨ç»éªŒ

### å¯¹Errorçš„å¤„ç†

### ObservableTypeç±»å‹çš„doOn æ“ä½œ

å¯ä»¥ç†è§£ä¸ºåœ¨è®¢é˜…æ¶ˆæ¯çš„åŒæ—¶ï¼Œç›‘å¬æ¯ä¸€ä¸ªæ¶ˆæ¯ï¼ŒonErroræ–¹æ³•ç›‘å¬Erroræ¶ˆæ¯ï¼Œå°±ä¼šè§¦å‘onErrorçš„Block

````
 Observable.of("ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹")
        .do(onNext: { print("Intercepted:", $0) }, onError: { print("Intercepted error:", $0) }, onCompleted: { print("Completed")  })
        .subscribe(onNext: { print($0) })
        .disposed(by: disposeBag)
````

### ActivityToken?


```
    fileprivate func trackActivityOfObservable<O: ObservableConvertibleType>(_ source: O) -> Observable<O.E> {
        return Observable.using({ () -> ActivityToken<O.E> in
            self.increment()
            return ActivityToken(source: source.asObservable(), disposeAction: self.decrement)
        }) { t in
            return t.asObservable()
        }
    }

```

### RxSwift é‡Œ map å’Œ flatMap?
å…ˆçœ‹çœ‹Swifté‡Œé¢ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š

```
let arrayNested = [[1,2,3,4,5],[6,7]]

let maped2 = arrayNested.map { $0 }
print(maped2) // [[1, 2, 3, 4, 5], [6, 7]]

let flaped2 = arrayNested.flatMap { $0 }
print(flaped2) // [1, 2, 3, 4, 5, 6, 7]

```

flatMap èƒ½å°†äºŒç»´æ•°ç»„å±•å¼€æˆä¸€ç»´æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯ *é™ç»´*
> flatMap è°ƒç”¨ä¸€æ¬¡åªèƒ½å±•å¼€ä¸€å±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚ä¸‰ç»´æ•°ç»„æ—¶è°ƒç”¨ä¸€æ¬¡flatMapä¼šå˜ä¸ºäºŒç»´æ•°ç»„ï¼Œè°ƒç”¨ä¸¤æ¬¡æ‰ä¼šå˜ä¸ºä¸€ç»´æ•°ç»„

RxSwiftä¸­ ä¹Ÿæ˜¯åŒæ ·çš„ç±»ä¼¼çš„æ¦‚å¿µ.

```
    let b = Observable.of( Observable.of("ğŸ¶", "ğŸ±"),
                           Observable.of("ğŸ­", "ğŸ¹"))
    
        b.map{ $0 }
        .subscribe(onNext: { element in
            print(element)
            //RxSwift.ObservableSequence<Swift.Array<Swift.String>>
            //RxSwift.ObservableSequence<Swift.Array<Swift.String>>
        })
        .disposed(by: disposeBag)

        b.flatMap{ $0 }
        .subscribe(onNext: { element in
            print(element)
            //ğŸ¶
            //ğŸ±
            //ğŸ­
            //ğŸ¹
        })
        .disposed(by: disposeBag)

```
ä¸¾ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­

```
button
    .rx
    .tap
    .map { URL(string: "http://httpbin/org")! }
    .flatMap(URLSession.shared.rx.JSON)
    .subscribe { event in
        switch event {
        // ...
        }
    }
    .addDisposableTo(disposeBag)
    
```
å¯ä»¥ç†è§£ä¸º 

```
Observable<Void> -> Observable<Foundation.URL> -> Observable<Observable<jsonData>>  

```
è¿™æ ·çš„è½¬æ¢ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ ç¬¬ä¸€mapä¼ å…¥çš„é—­åŒ…è¿”å›çš„æ˜¯ `URL` 
 
```
 	{ _ -> URL in 
		retrun URL(string: "http://httpbin/org")! 
	}

```

è€Œç¬¬äºŒæ­¥flatMapä¼ å…¥çš„é—­åŒ…è¿”å›çš„æ˜¯ `Observable<jsonData>`

```
public func json(url: Foundation.URL) -> Observable<jsonData> {
    return json(request: URLRequest(url: url))
}
```

Rxswift ä¸­ Observable å’Œ Swift çš„ [] æ•°ç»„ å¾ˆåƒã€‚

Swift çš„ flatMap å¯ä»¥ä½¿ [[1,2,3,4,5],[6,7]] -> [1,2,3,4,5,6,7]

Rxswift çš„ flatMap å¯ä»¥ä½¿ Observable<Observable<Any>> -> Observable<Any>

è¿˜å¯ä»¥ç†è§£ä¸º ç¬¬äºŒä¸ªæ˜ å°„ *(map/flatmap éƒ½å¯ä»¥ç†è§£ä¸ºæ˜ å°„)* æ˜¯ä¸€ä¸ªå‡ç»´çš„è¿‡ç¨‹ *(ä»ä¸€ç»´å˜äºŒç»´)* éœ€è¦ç”¨flatmapå‡½æ•°å°†è¿™ä¸ªå‡èµ·çš„ç»´åº¦é™å›æ¥ï¼Œæ‹¿åˆ°å’±ä»¬çœŸæ­£è¦æƒ³è¦çš„ *Observable<jsonData>* 
å½“ä¸çŸ¥é“ç”¨mapå’Œflatmapå“ªä¸€ä¸ªæ—¶ï¼Œè€ƒè™‘ä¸‹ç°åœ¨çš„ç»´åº¦æ˜¯ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚Rxswifté‡Œ *Value -> Observable<E>* è¿™æ ·çš„è¿‡ç¨‹éƒ½æ˜¯å‡ç»´çš„ã€‚

æ­¤å¤– flatMap è¿˜æœ‰ä¸¤ä¸ªå…„å¼Ÿæ–¹æ³•ï¼ŒflatMapFirst flatMapLatest ï¼Œæ¯”å¦‚åœ¨ç½‘ç»œè¯·æ±‚æœªå®Œæˆæ—¶ï¼Œå†æ¬¡ç‚¹å‡»äº† Button ï¼ŒflatMapFirst ä¼šå¿½ç•¥ç¬¬äºŒæ¬¡ç‚¹å‡» Button çš„äº‹ä»¶ï¼Œä¸ä¼šè¿›è¡Œç½‘ç»œè¯·æ±‚ï¼›è€Œ flatMapLatest ä¼šå–æ¶ˆç¬¬ä¸€æ¬¡çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥ç¬¬äºŒæ¬¡çš„ç½‘ç»œè¯·æ±‚è¦†ç›–æ‰ã€‚

[å‚è€ƒ](http://edison-hsu.com/blog/2016/12/11/RxSwiftä¸­FlapMapå’ŒMapçš„åŒºåˆ«)


## æ€»ç»“
RxSwift å‡½æ•°å¼ç¼–ç¨‹ï¼šå‡½æ•°å¼æ€ç»´ï¼Œå…¶å®å°±æ˜¯ç»„åˆå­é€»è¾‘ï¼Œç”¨ç®€å•çš„å‡ ä¸ªå‡½æ•°ç»„åˆæ¥æ„å»ºå¤æ‚é€»è¾‘ï¼Œå§‹ç»ˆä»¥é«˜é˜¶çš„è§’åº¦å»è¡¨è¾¾é—®é¢˜ï¼Œè€Œéä¾èµ–å‰¯ä½œç”¨ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å‡½æ•°å¼ç¼–ç¨‹æ„å‘³ç€ä¸ä½¿ç”¨å¯å˜çš„å˜é‡ï¼Œèµ‹å€¼ï¼Œå¾ªç¯å’Œå…¶ä»–å‘½ä»¤å¼æ§åˆ¶ç»“æ„è¿›è¡Œç¼–ç¨‹ã€‚
ReactiveXæ˜¯Reactive Extensionsçš„ç¼©å†™ï¼Œä¸€èˆ¬ç®€å†™ä¸ºRx ã€‚Rxæ˜¯ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹ï¼Œç›®æ ‡æ˜¯æä¾›ä¸€è‡´çš„ç¼–ç¨‹æ¥å£ï¼Œå¸®åŠ©å¼€å‘è€…æ›´æ–¹ä¾¿çš„å¤„ç†å¼‚æ­¥æ•°æ®æµ

Rxçš„Observableæ¨¡å‹è®©ä½ å¯ä»¥åƒä½¿ç”¨é›†åˆæ•°æ®ä¸€æ ·æ“ä½œå¼‚æ­¥äº‹ä»¶æµï¼Œå¯¹å¼‚æ­¥äº‹ä»¶æµä½¿ç”¨å„ç§ç®€å•ã€å¯ç»„åˆçš„æ“ä½œã€‚

è¿‡æ»¤(filter)ã€é€‰æ‹©(select)ã€å˜æ¢(transform)ã€ç»“åˆ(combine)å’Œç»„åˆ(compose)å¤šä¸ªObservable

æ€§èƒ½ä¸Šï¼é«˜é˜¶æ•°æ®ç®—æ³• å¯ä»¥è®²ä»»åŠ¡åˆ†æˆå°å—å„¿ åˆ©ç”¨å¤šæ ¸è¿ç®— æ€§èƒ½å¿« ã€‚
å®‰å…¨ä¸Šï¼å› ä¸ºä¸ä¿®æ”¹å‚æ•°å€¼ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨ å› ä¸ºéƒ½æ˜¯å€¼ç±»å‹ è¾“å…¥ä¸€æ ·è¾“å‡ºå°±ä¸€æ ·
æ€æƒ³ä¸Šï¼ç”¨ç®€å•çš„å‡ ä¸ªå‡½æ•°ç»„åˆæ¥æ„æˆå¤æ‚çš„é€»è¾‘ï¼Œå§‹ç»ˆä»¥é«˜ä»·çš„è§’åº¦å»è¡¨è¾¾é—®é¢˜ï¼Œè€Œéä¾èµ–å‰¯ä½œç”¨ï¼Œå¼‚æ­¥æ“ä½œprimose

è‡ªæˆ‘æ€»ç»“çš„å‡½æ•°å¼ç¼–ç¨‹ï¼š
          åƒä»¥å‰æœåŠ¡å™¨çš„apiä¸æ˜¯Restfulé£æ ¼ä¸€æ ·ï¼Œå…¶å®æ“ä½œæ•°æ®çš„æ–¹å¼å¯ä»¥æŠ½è±¡å½’çº³ä¸ºå‡ ç§æ¯”å¦‚ï¼šå¢åˆ æ”¹æŸ¥å°±å¤Ÿäº†ã€‚è€Œå‡½æ•°å¼ç¼–ç¨‹åˆ™æ˜¯æŠŠæŠ½è±¡å½’çº³æ“ä½œæ•°æ®çš„å‡ ç§æ–¹æ³• æ¯”å¦‚ï¼šMap è½¬æ¢ Reduce è¿­ä»£ filter ç­›é€‰ connect è¿æ¥ combine ç»„åˆ ç­‰æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°éƒ½ç”¨blockå°è£…èµ·æ¥ï¼Œ

Wiki ç™¾ç§‘ï¼š
          å®ƒå°†ç”µè„‘è¿ç®—è§†ä¸ºæ•°å­¦ä¸Šçš„å‡½æ•°è®¡ç®—ï¼Œå¹¶ä¸”é¿å…ä½¿ç”¨ç¨‹åºçŠ¶æ€ä»¥åŠæ˜“å˜å¯¹è±¡ã€‚å‡½æ•°ç¼–ç¨‹è¯­è¨€æœ€é‡è¦çš„åŸºç¡€æ˜¯Î»æ¼”ç®—ï¼ˆlambda calculusï¼‰ã€‚è€Œä¸”Î»æ¼”ç®—çš„å‡½æ•°å¯ä»¥æ¥å—å‡½æ•°å½“ä½œè¾“å…¥ï¼ˆå¼•æ•°ï¼‰å’Œè¾“å‡ºï¼ˆä¼ å‡ºå€¼ï¼‰ã€‚